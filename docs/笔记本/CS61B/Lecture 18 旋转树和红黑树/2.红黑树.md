# The 2-3 Tree Isometry（等距）
![](附件/Pasted%20image%2020251005220552.png)
对于一个L=2的B树，我们该怎样把它变成一个二叉搜索树呢，上图中当每个节点都只有一个元素的时候，二叉搜索树就是B树不用做任何改动，但是当一个节点中有两个元素的时候，我们又该怎么办？
答案如下：上面讲过旋转的一个操作就是先合并再移动，我们可以把这个d与f看成刚合并完还没移动的时候，我们**统一让左侧的元素往下移动**(也可以让右侧往下移，但是为了方便并且要统一，所以普遍左移而不右移)，**树枝画成红色代表在B树中它们存在于同一个节点**，只是转换成二叉搜索输的时候左侧的元素被旋转下去了，这就是**左倾红黑二叉搜索树**(Left-Learning Red Black Binary Search Tree，简称**LLRB**）
![](附件/Pasted%20image%2020251005220817.png)

- LLRBs和普通的二叉搜索树一样。
- LLRBs和2-3tree是一一对应的。不存在其中一棵树的形态能对应另一种树的多种形态。
- 红色只是用来标记这两个元素在2-3 tree中处于同一个节点，并没有什么特别之处。

![](附件/Pasted%20image%2020251005220901.png)

---

# LLRB 的性质
![](附件/Pasted%20image%2020251005221116.png)
这四个是将LLRB还原成B-tree后的样子，只有最后一个是符合2-3 B-Tree的，首先第一幅图的节点超出了L=2这一限制范围，因此直接排除。第二和第三幅图看似很正确，但是B-Trees严格遵循所有叶子高度相同原则，因此这两个也排除，所以只有第四个是符合的。

![](附件/Pasted%20image%2020251005221213.png)

在最好的情况下，LLRB跟2-3 B-Tree的高度是相同的(也就是每个节点都只含有一个元素)在最坏的情况下，当2-3 B-Tree的高度为H时，LLRB的高度为2H+1，其中一条路径的每一个节点都包含两个元素，那就会导致这条路径的红色枝条和黑色枝条一样多。由于B-Tree的高度遵循O(logN)，所以LLRB的高度也遵循O(logN)。

---

# Extra：LLRB Invariants

1. 一个节点不可能连两个红色枝条
2. 每条路径的黑色枝条数量都是一样的。
  - 因为黑色枝条的数量就是B-trees的高度，而B-trees的每片叶子高度都一样。
  ![](附件/Pasted%20image%2020251005221437.png)

---

# Maintaining Isometry with Rotations
我们应该如何建立LLRB？如果先建立2-3 B-trees再将其一步步转化为红黑树会是一个非常麻烦的过程。相反，我们应该按照如下操作进行LLRB插入：
**像往常一样插入到BST中，然后再使用0次或者多次旋转来维持一一映射。**
**在建立LLRB时，每插入一个元素，都需要用红色树枝连接。**
![](附件/Pasted%20image%2020251005221549.png)


## 例一：
![](附件/Pasted%20image%2020251005221625.png)
  题目要求我们把S接到E上。
- 第一步就是刚才说过的，把这棵树当成正常的二叉搜索树(BST)来进行插入，因为S比E大，所以接在E的右边，因为每次进行插入的时候都需要用红色枝条，因此第一步就是用红色枝条把S接到E的右边。
- 第二步就要判断这个新的树是否符合LLRB的特性，由于LLRB的红色枝条都要连在左侧，而此时的红色枝条连在右侧，因此需要对E进行左旋，这样才能得到正确的LLRB


## 例二：下面来看看上题的进阶版，有两种不同的情况：

![](附件/Pasted%20image%2020251005221806.png)
![](附件/Pasted%20image%2020251005221901.png)
![](附件/Pasted%20image%2020251005222018.png)

---

# Runtime and Implementation

![](附件/Pasted%20image%2020251005222256.png)

---

# Search Tree Summary

In the last 3 lectures, we talked about using search trees to implement sets/maps.

- Binary search trees are simple, but they are subject to imbalance.
    - 容易不平衡，有可能变成只有一条路径的树枝

- 2-3 Trees (B Trees) are balanced, but painful to implement and relatively slow.

- LLRBs insertion is simple to implement (but delete is hard).

- Works by maintaining mathematical bijection with a 2-3 trees.

- Java’s [TreeMap](https://github.com/AdoptOpenJDK/openjdk-jdk11/blob/999dbd4192d0f819cb5224f26e9e7fa75ca6f289/src/java.base/share/classes/java/util/TreeMap.java) is a red-black tree (not left leaning).

- Maintains correspondence with 2-3-4 tree (is not a 1-1 correspondence).

- Allows glue links on either side (see [Red-Black Tree](http://en.wikipedia.org/wiki/Red%E2%80%93black_tree)).

- More complex implementation, but significantly (?) faster.




